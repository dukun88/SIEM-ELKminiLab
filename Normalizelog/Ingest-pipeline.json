PUT _ingest/pipeline/soc-normalize
{
  "description": "SOC mixed log normalization to ECS",
  "processors": [

    {
      "grok": {
        "field": "message",
        "patterns": [

          "%{SYSLOGTIMESTAMP:temp.timestamp} %{HOSTNAME:host.hostname} kernel: .*SRC=%{IP:source.ip} DST=%{IP:destination.ip}.*PROTO=%{WORD:network.transport} SPT=%{INT:source.port} DPT=%{INT:destination.port}",

          "%{SYSLOGTIMESTAMP:temp.timestamp} %{HOSTNAME:host.hostname} %{WORD:process.name}\\[%{INT:process.pid}\\]: Failed password for .* from %{IP:source.ip} port %{INT:source.port}",
          "%{SYSLOGTIMESTAMP:temp.timestamp} %{HOSTNAME:host.hostname} %{WORD:process.name}\\[%{INT:process.pid}\\]: Accepted password for .* from %{IP:source.ip} port %{INT:source.port}",

          "%{SYSLOGTIMESTAMP:temp.timestamp} %{HOSTNAME:host.hostname} %{WORD:process.name}\\[%{INT}\\]: (GET|POST) %{URI:url.original} %{INT:http.response.status_code}",

          "%{SYSLOGTIMESTAMP:temp.timestamp} %{HOSTNAME:host.hostname} dnsmasq\\[%{INT}\\]: query\\[A\\] %{DATA:dns.question.name} from %{IP:source.ip}",
          "%{SYSLOGTIMESTAMP:temp.timestamp} %{HOSTNAME:host.hostname} dnsmasq\\[%{INT}\\]: reply %{DATA:dns.question.name} is %{IP:dns.resolved_ip}",

          "%{SYSLOGTIMESTAMP:temp.timestamp} %{HOSTNAME:host.hostname} suricata\\[%{INT}\\]: \\[%{DATA:rule.id}\\] %{DATA:rule.name} \\{%{WORD:network.transport}\\} %{IP:source.ip}:%{INT:source.port} -> %{IP:destination.ip}:%{INT:destination.port}",

          "%{SYSLOGTIMESTAMP:temp.timestamp} %{HOSTNAME:host.hostname} Security: EventID=%{INT:event.code} AccountName=%{WORD:user.name} WorkstationName=%{WORD:host.name} SourceNetworkAddress=%{IP:source.ip}",

          "%{SYSLOGTIMESTAMP:temp.timestamp} %{HOSTNAME:host.hostname} postfix/smtpd: connect from .*\\[%{IP:source.ip}\\]",
          "%{SYSLOGTIMESTAMP:temp.timestamp} %{HOSTNAME:host.hostname} postfix/smtpd: warning: .*\\[%{IP:source.ip}\\]: SASL LOGIN authentication failed",

          "%{SYSLOGTIMESTAMP:temp.timestamp} %{HOSTNAME:host.hostname} openvpn\\[%{INT}\\]: Peer Connection Initiated with .*%{IP:source.ip}:%{INT:source.port}",
          "%{SYSLOGTIMESTAMP:temp.timestamp} %{HOSTNAME:host.hostname} openvpn\\[%{INT}\\]: AUTH_FAILED, user=%{WORD:user.name}"
        ],
        "ignore_failure": true
      }
    },

    {
      "date": {
        "field": "temp.timestamp",
        "formats": ["MMM d HH:mm:ss", "MMM dd HH:mm:ss"],
        "ignore_failure": true
      }
    },

    {
      "set": {
        "field": "event.module",
        "value": "soc"
      }
    },

    {
      "script": {
        "source": """
        if (ctx.message.contains("Failed password")) {
          ctx.event = ['category':'authentication','outcome':'failure'];
        } else if (ctx.message.contains("Accepted password")) {
          ctx.event = ['category':'authentication','outcome':'success'];
        } else if (ctx.message.contains("CobaltStrike")) {
          ctx.event = ['category':'malware','type':'beacon'];
        } else if (ctx.message.contains("SQL Injection")) {
          ctx.event = ['category':'web','type':'attack'];
        } else if (ctx.message.contains("Suspicious Scan")) {
          ctx.event = ['category':'intrusion_detection','type':'scan'];
        }
        """
      }
    },

    {
      "geoip": {
        "field": "source.ip",
        "target_field": "source.geo",
        "ignore_failure": true
      }
    },

    {
      "remove": {
        "field": ["temp"],
        "ignore_failure": true
      }
    }

  ]
}
